<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CUSTOMER Portal</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            display: flex;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .container {
            display: flex;
            width: 100%;
            max-width: 1400px;
            margin: 20px auto;
            gap: 20px;
            padding: 0 20px;
        }

        /* Main Panel */
        .main-panel {
            flex: 1;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .panel-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 32px;
            text-align: center;
        }

        .panel-header h1 {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .panel-header p {
            font-size: 16px;
            opacity: 0.95;
        }

        .panel-content {
            flex: 1;
            padding: 32px;
            overflow-y: auto;
        }

        /* Registration Section */
        .section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 28px;
            margin-bottom: 20px;
            border: 2px solid #e9ecef;
        }

        .section h3 {
            font-size: 20px;
            color: #2d3748;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .step-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 8px;
        }

        input[type="text"],
        input[type="email"],
        select,
        textarea {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.2s;
            background: white;
            color: #2d3748;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        }

        input[readonly] {
            background: #f7fafc;
            color: #718096;
            cursor: not-allowed;
        }

        select {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%234a5568'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 20px;
            padding-right: 40px;
        }

        button {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        /* Chat Room */
        .chat-room {
            display: none;
        }

        .chat-room.active {
            display: flex;
            flex-direction: column;
            height: 500px;
        }

        .chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 24px;
            border-radius: 12px 12px 0 0;
            margin: -28px -28px 20px -28px;
        }

        .chat-header h3 {
            font-size: 18px;
            margin-bottom: 4px;
            color: white;
        }

        .agent-info {
            font-size: 14px;
            opacity: 0.95;
        }

        #message-list {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #edf2f7;
            border-radius: 12px;
            margin-bottom: 16px;
        }

        .message-row {
            display: flex;
            margin-bottom: 16px;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .msg-customer {
            justify-content: flex-end;
        }

        .msg-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 16px;
            font-size: 15px;
            line-height: 1.5;
            word-wrap: break-word;
        }

        .msg-bubble.CUSTOMER {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .msg-bubble.AGENT {
            background: white;
            color: #2d3748;
            border: 1px solid #e2e8f0;
            border-bottom-left-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .msg-bubble.SYSTEM {
            background: #fef5e7;
            color: #f59e0b;
            text-align: center;
            font-size: 14px;
            font-style: italic;
            border: 1px solid #fbbf24;
            max-width: 85%;
            margin: 0 auto;
        }

        .message-input-wrapper {
            display: flex;
            gap: 10px;
        }

        .message-input-wrapper input {
            flex: 1;
            border-radius: 24px;
            padding: 14px 20px;
        }

        .message-input-wrapper button {
            width: auto;
            padding: 14px 28px;
            border-radius: 24px;
        }

        /* Logs Panel */
        .logs-panel {
            width: 350px;
            background: #1a1a1a;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .logs-header {
            background: #0f0f0f;
            padding: 20px 24px;
            border-bottom: 1px solid #333;
        }

        .logs-header h2 {
            color: #4ade80;
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #logs {
            flex: 1;
            background: #1a1a1a;
            color: #4ade80;
            border: none;
            padding: 20px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.6;
            resize: none;
        }

        /* Status Indicator */
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            font-size: 13px;
            margin-top: 12px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: #4ade80;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a0aec0;
        }

        #logs::-webkit-scrollbar-track {
            background: #0f0f0f;
        }

        #logs::-webkit-scrollbar-thumb {
            background: #333;
        }

        /* Responsive */
        @media (max-width: 968px) {
            .container {
                flex-direction: column;
            }

            .logs-panel {
                width: 100%;
                height: 300px;
            }
        }

        /* Helper Text */
        .helper-text {
            font-size: 13px;
            color: #718096;
            margin-top: 8px;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            border: 1px solid #c3e6cb;
        }
    </style>
</head>



<body>

<div class="container">
    <!-- Main Panel -->
    <div class="main-panel">
        <div class="panel-header">
            <h1>ðŸ’¬ Customer Support</h1>
            <p>Connect with our support team instantly</p>
        </div>

        <div class="panel-content">
            <!-- Step 1: Registration -->
            <div id="register-panel">
                <div class="section">
                    <h3>
                        <span class="step-badge">1</span>
                        Your Details
                    </h3>
                    <div class="form-group">
                        <label for="cust-name">Full Name</label>
                        <input type="text" id="cust-name" value="Mohan" placeholder="Enter your full name">
                    </div>
                    <div class="form-group">
                        <label for="cust-email">Email Address</label>
                        <input type="email" id="cust-email" value="mohan@test.com" placeholder="your.email@example.com">
                    </div>
                    <div class="form-group">
                        <label for="cust-id">Customer ID</label>
                        <input type="text" id="cust-id" readonly placeholder="Will be generated after registration">
                        <div class="helper-text">Your unique identifier will appear here</div>
                    </div>
                    <button class="btn-primary" id="register-btn">Register & Connect</button>
                </div>
            </div>

            <!-- Step 2: Start Chat -->
            <div id="start-chat-panel" style="display: none;">
                <div class="success-message" id="connection-success">
                    âœ… Connected successfully! You can now start a chat with our support team.
                </div>

                <div class="section">
                    <h3>
                        <span class="step-badge">2</span>
                        Start a Conversation
                    </h3>
                    <div class="form-group">
                        <label for="issue-type">What do you need help with?</label>
                        <select id="issue-type">
                            <!--  PAYMENT-RELATED ISSUES -->
                            <option value="PAYMENT_DEDUCTED_NOT_RECEIVED">
                                Amount has been debited from your account, but the transaction has not reflected on our end. (Urgent - P5)
                            </option>

                            <option value="DOUBLE_PAYMENT_ISSUE">
                                Duplicate Payment Made â€” You have been charged twice for the same transaction or order. (Urgent - P5)
                            </option>

                            <option value="PAYMENT_FAILED">
                                Payment Failed but Amount Debited â€” Transaction failed midway, yet funds were deducted from your account. (High Priority - P4)
                            </option>

                            <option value="PAYMENT_PENDING_CONFIRMATION">
                                 Payment Pending Confirmation â€” Payment is under processing or awaiting confirmation from your bank. (Medium Priority - P3)
                            </option>

                            <option value="REFUND_DELAYED">
                                Refund Delayed â€” Refund has not been credited to your account within the expected timeline. (Medium Priority - P3)
                            </option>

                            <option value="PAYMENT_HISTORY_REQUEST">
                                 Payment History Request â€” You wish to receive a detailed history or summary of your past transactions. (Low Priority - P2)
                            </option>

                            <option value="BILLING_QUERY">
                                 Billing Discrepancy or Clarification â€” You have a question or concern regarding billing details, charges, or invoices. (Low Priority - P2)
                            </option>


                            <!--  LOAN-RELATED INQUIRIES -->
                            <option value="LOAN_APPROVAL_INQUIRY">
                                 Loan Approval Inquiry â€” Checking the status or eligibility of your submitted loan application. (High Priority - P4)
                            </option>

                            <option value="LOAN_DISBURSEMENT_DELAY">
                                 Loan Disbursement Delay â€” Loan amount has been approved but not yet credited to your account. (Urgent - P5)
                            </option>

                            <option value="LOAN_REPAYMENT_QUERY">
                                Loan Repayment or EMI Query â€” Questions about EMI schedules, payment dates, or repayment options. (Medium Priority - P3)
                            </option>

                            <option value="LOAN_FORECLOSURE_REQUEST">
                                 Loan Foreclosure / Prepayment Request â€” Intention to close the loan account before the full tenure by paying outstanding dues. (Low Priority - P2)
                            </option>


                            <!--  FINANCIAL / ACCOUNT ISSUES -->
                            <option value="ACCOUNT_UPDATE_INQUIRY">
                                 Account Update Request â€” Need to update personal or account-related details such as address, contact number, or KYC information. (Low Priority - P2)
                            </option>

                            <option value="ACCOUNT_VERIFICATION_ISSUE">
                                Account Verification Issue â€” Facing trouble with KYC verification or account activation steps. (High Priority - P4)
                            </option>

                            <option value="STATEMENT_REQUEST">
                                 Account Statement or Summary Request â€” Requesting a detailed monthly or yearly account statement. (Medium Priority - P3)
                            </option>

                            <option value="LIMIT_INCREASE_REQUEST">
                                 Credit / Transaction Limit Increase â€” Seeking an increase in your card or transaction limit. (Low Priority - P2)
                            </option>


                            <!--  GENERAL INQUIRIES -->
                            <option value="GENERAL_INQUIRY">
                                 General Information or Assistance â€” Any general or non-urgent query related to our services or platform. (P1)
                            </option>

                            <option value="FEEDBACK_OR_SUGGESTION">
                                 Feedback or Suggestion â€” Share feedback, improvement ideas, or appreciation about our services. (P1)
                            </option>

                        </select>
                    </div>
                    <div class="form-group">
                        <label for="message-body">Describe your issue</label>
                        <textarea id="message-body" rows="4" placeholder="Please provide details about your issue..."></textarea>
                        <div class="helper-text">Be as specific as possible to help us assist you better</div>
                    </div>
                    <button class="btn-primary" id="start-chat-btn">Start Chat with Agent</button>
                </div>
            </div>

            <!-- Step 3: Chat Room -->
            <div id="chat-room" class="chat-room">
                <div class="section" style="padding: 28px; margin: 0;">
                    <div class="chat-header">
                        <h3>Live Chat Session</h3>
                        <div class="agent-info">
                            <span>Agent: </span><strong id="agent-name">Waiting for assignment...</strong>
                        </div>
                        <div class="status-indicator">
                            <span class="status-dot"></span>
                            <span>Connected</span>
                        </div>
                    </div>

                    <div id="message-list"></div>

                    <div class="message-input-wrapper">
                        <input type="text" id="message-input" placeholder="Type your message...">
                        <button class="btn-primary" id="send-btn">Send</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Logs Panel -->
    <div class="logs-panel">
        <div class="logs-header">
            <h2>
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                    <path d="M10.97 4.97a.235.235 0 0 0-.02.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-1.071-1.05z"/>
                </svg>
                System Events
            </h2>
        </div>
        <textarea id="logs" readonly></textarea>
    </div>
</div>

<script>
    let stompClient = null;
    let currentCustomerId = null;
    let currentConvoId = null;
    const logs = document.getElementById('logs');

    function log(message, type = 'info') {
        const timestamp = new Date().toLocaleTimeString();
        const icon = {
            'info': 'Ã¢â€žÂ¹',
            'success': 'Ã¢Å“â€œ',
            'error': 'Ã¢Å“â€”',
            'msg': 'Ã¢â€ â€™'
        }[type] || 'Ã¢â€žÂ¹';

        logs.value += `[${timestamp}] ${icon} [${type.toUpperCase()}] ${message}\n`;
        logs.scrollTop = logs.scrollHeight;
    }

    function displayMessage(sender, body, isSystem = false) {
        const list = document.getElementById('message-list');
        const senderType = sender.toUpperCase();

        const container = document.createElement('div');
        container.className = 'message-row';

        const bubble = document.createElement('div');
        bubble.className = `msg-bubble ${senderType}`;
        bubble.innerText = body;

        if (isSystem) {
            bubble.innerText = `Ã¢â‚¬â€ ${body} Ã¢â‚¬â€`;
        } else if (senderType === 'CUSTOMER') {
            container.classList.add('msg-customer');
        }

        container.appendChild(bubble);
        list.appendChild(container);
        list.scrollTop = list.scrollHeight;
    }

    // Step 1: Register & Connect
    document.getElementById('register-btn').onclick = async function() {
        const email = document.getElementById('cust-email').value;
        const name = document.getElementById('cust-name').value;

        if (!email || !name) {
            log('Please fill in all fields', 'error');
            return;
        }

        log('Attempting registration...', 'info');

        const response = await fetch('http://localhost:8080/api/customer/register', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ email: email, name: name })
        });

        if (!response.ok) {
            log(`Registration failed: ${response.status}`, 'error');
            return;
        }

        const customer = await response.json();
        currentCustomerId = customer.id;
        document.getElementById('cust-id').value = currentCustomerId;
        log(`Registration successful! Customer ID: ${currentCustomerId}`, 'success');

        document.getElementById('register-panel').style.display = 'none';
        document.getElementById('start-chat-panel').style.display = 'block';

        // Connect to WebSocket
        log('Connecting to WebSocket...', 'info');
        stompClient = Stomp.client("ws://localhost:8080/ws-connect");
        stompClient.connect(
            { "login": currentCustomerId },
            (frame) => {
                log("WebSocket connected successfully!", 'success');
                const privateTopic = `/topic/customer/${currentCustomerId}`;
                stompClient.subscribe(privateTopic, onAssignmentReceived);
            },
            (error) => {
                log(`WebSocket connection error: ${error}`, 'error');
            }
        );
    }

    // Step 2: Start Chat
    document.getElementById('start-chat-btn').onclick = async function() {
        const issueType = document.getElementById('issue-type').value;
        const body = document.getElementById('message-body').value;
        const email = document.getElementById('cust-email').value;
        const name = document.getElementById('cust-name').value;

        if (!body.trim()) {
            log('Please describe your issue', 'error');
            return;
        }

        log('Requesting chat session...', 'info');

        const response = await fetch('http://localhost:8080/api/chat/start', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                email: email,
                name: name,
                issueTypeString: issueType,
                body: body
            })
        });

        if (response.status === 202) {
            log("Chat request accepted. Waiting for agent assignment...", 'success');
            document.getElementById('start-chat-panel').style.display = 'none';
        } else {
            log(`Error starting chat: ${response.status}`, 'error');
        }
    }

    // Step 3: Handle Agent Assignment
    function onAssignmentReceived(message) {
        log("Ã¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢Â AGENT ASSIGNED Ã¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢Â", 'success');
        const notification = JSON.parse(message.body);
        currentConvoId = notification.conversationId;

        log(`Agent: ${notification.participantName}`, 'success');
        log(`Priority: P${notification.urgencyScore}`, 'info');
        log(`Conversation ID: ${currentConvoId}`, 'info');

        document.getElementById('agent-name').innerText = notification.participantName;
        document.getElementById('chat-room').classList.add('active');
        document.getElementById('message-list').innerHTML = '';

        // Subscribe to chat room
        const topic = `/topic/conversation/${currentConvoId}`;
        stompClient.subscribe(topic, onChatMessageReceived);
    }

    // Step 4: Handle Incoming Messages
    function onChatMessageReceived(message) {
        const parsedBody = JSON.parse(message.body);

        if (parsedBody.body) {
            displayMessage(parsedBody.senderType, parsedBody.body);
            log(`Message from ${parsedBody.senderType}`, 'msg');
        } else if (parsedBody.message) {
            displayMessage('SYSTEM', parsedBody.message, true);
            log('Chat session ended', 'info');

            setTimeout(() => {
                document.getElementById('chat-room').classList.remove('active');
                document.getElementById('start-chat-panel').style.display = 'block';
                document.getElementById('message-body').value = '';
                currentConvoId = null;
            }, 2000);
        }
    }

    // Step 5: Send Message
    document.getElementById('send-btn').onclick = function() {
        const message = document.getElementById('message-input').value;
        if (!message.trim()) return;

        const destination = `/app/chat/send/${currentConvoId}`;
        stompClient.send(destination, {}, JSON.stringify({ body: message }));

        log(`Sent: ${message.substring(0, 30)}${message.length > 30 ? '...' : ''}`, 'msg');
        document.getElementById('message-input').value = '';
    }

    // Enter key to send
    document.getElementById('message-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            document.getElementById('send-btn').click();
        }
    });

    // Initial log
    log('Customer Portal initialized', 'info');
    log('Please register to begin', 'info');
</script>

</body>
</html>
